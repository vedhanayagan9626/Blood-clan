{% extends "layout.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-tint me-2"></i>
                    Request Details
                </h4>
                <span class="badge bg-light text-dark">ID: {{ request.id }}</span>
            </div>
            <div class="card-body">
                <h3 class="card-title">{{ request.title }}</h3>
                <p class="card-text">{{ request.description or 'No additional details provided.' }}</p>
                
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Blood Group Needed:</strong>
                        <span class="badge bg-primary ms-2 fs-6">{{ request.blood_group }}</span>
                    </div>
                    <div class="col-sm-6">
                        <strong>Units Required:</strong>
                        <span class="text-danger fw-bold">{{ request.units_needed }}</span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Location:</strong><br>
                        <i class="fas fa-map-marker-alt text-muted me-1"></i>
                        {{ request.address or 'Location not specified' }}
                    </div>
                    <div class="col-sm-6">
                        <strong>Posted:</strong><br>
                        <i class="fas fa-clock text-muted me-1"></i>
                        {{ request.created_at.strftime('%B %d, %Y at %I:%M %p') if request.created_at else 'Unknown' }}
                    </div>
                </div>
                
                {% if request.expires_at %}
                <div class="alert alert-warning">
                    <i class="fas fa-hourglass-half me-2"></i>
                    <strong>Expires:</strong> {{ request.expires_at.strftime('%B %d, %Y at %I:%M %p') }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Donor Registration Section -->
        <div class="card shadow mt-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-hand-holding-medical me-2"></i>
                    Become a Donor
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    First, check your blood group using our AI fingerprint detection above, then register as a donor if you're compatible.
                </div>
                
                <!-- Fingerprint Upload -->
                <div id="donate-upload-area" class="border border-success rounded p-3 mb-3 text-center">
                    <div id="donate-upload-placeholder">
                        <i class="fas fa-fingerprint fa-2x text-success mb-2"></i>
                        <p class="mb-2">Upload fingerprint to verify blood group</p>
                        <input id="donateFingerprint" type="file" accept="image/*" class="d-none" />
                        <button id="selectDonateFile" class="btn btn-outline-success">
                            <i class="fas fa-image me-2"></i>Select Fingerprint
                        </button>
                    </div>
                    <div id="donate-image-preview" class="d-none">
                        <img id="donate-preview-img" src="" alt="Preview" class="img-fluid mb-3" style="max-height: 150px;">
                        <div>
                            <button id="predictDonateBtn" class="btn btn-success me-2">
                                <i class="fas fa-brain me-2"></i>Verify Blood Group
                            </button>
                            <button id="clearDonateBtn" class="btn btn-secondary">Clear</button>
                        </div>
                    </div>
                </div>
                
                <div id="donateResult" class="mb-3"></div>
                
                <!-- Donor Registration Form -->
                <form id="donorForm" class="d-none">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Your Name *</label>
                            <input type="text" id="donorName" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Contact (Phone/Email) *</label>
                            <input type="text" id="donorContact" class="form-control" required>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="donorConsent" required>
                                <label class="form-check-label" for="donorConsent">
                                    I consent to share my contact information with the blood requester.
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-heart me-2"></i>Register as Donor
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Contact Information -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-phone me-2"></i>
                    Contact Information
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Contact Person:</strong><br>
                    <i class="fas fa-user text-muted me-1"></i>
                    {{ request.contact_name }}
                </div>
                <div class="mb-3">
                    <strong>Phone:</strong><br>
                    <i class="fas fa-phone text-muted me-1"></i>
                    <a href="tel:{{ request.contact_phone }}" class="text-decoration-none">
                        {{ request.contact_phone }}
                    </a>
                </div>
                {% if request.contact_email %}
                <div class="mb-3">
                    <strong>Email:</strong><br>
                    <i class="fas fa-envelope text-muted me-1"></i>
                    <a href="mailto:{{ request.contact_email }}" class="text-decoration-none">
                        {{ request.contact_email }}
                    </a>
                </div>
                {% endif %}
                
                <div class="d-grid gap-2">
                    <a href="tel:{{ request.contact_phone }}" class="btn btn-danger">
                        <i class="fas fa-phone me-2"></i>Call Now
                    </a>
                    {% if request.contact_email %}
                    <a href="mailto:{{ request.contact_email }}" class="btn btn-outline-primary">
                        <i class="fas fa-envelope me-2"></i>Send Email
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Registered Donors -->
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Registered Donors ({{ request.donors|length }})
                </h5>
            </div>
            <div class="card-body">
                {% if request.donors %}
                    <div class="list-group list-group-flush">
                        {% for donor in request.donors %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ donor.donor_name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ donor.donor_blood_group }}</small>
                                    {% if donor.prediction_confidence %}
                                    <small class="text-success">
                                        ({{ "%.1f"|format(donor.prediction_confidence * 100) }}% confidence)
                                    </small>
                                    {% endif %}
                                </div>
                                <small class="text-muted">
                                    {{ donor.created_at.strftime('%m/%d/%Y') }}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-user-plus fa-2x mb-2"></i>
                        <p>No donors registered yet.<br>Be the first to help!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Back Button -->
<div class="row mt-4">
    <div class="col-12">
        <a href="/requests" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Requests
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let predictedGroup = '';
    let confidence = 0;
    const requestId = {{ request.id }};
    
    const requiredGroup = '{{ request.blood_group }}';

    // File selection for donation
    $('#selectDonateFile').on('click', function() {
        $('#donateFingerprint').click();
    });

    $('#donateFingerprint').on('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#donate-preview-img').attr('src', e.target.result);
                $('#donate-upload-placeholder').addClass('d-none');
                $('#donate-image-preview').removeClass('d-none');
            };
            reader.readAsDataURL(file);
        }
    });

    $('#clearDonateBtn').on('click', function() {
        $('#donateFingerprint').val('');
        $('#donate-image-preview').addClass('d-none');
        $('#donate-upload-placeholder').removeClass('d-none');
        $('#donateResult').empty();
        $('#donorForm').addClass('d-none');
    });

    // Predict blood group
    $('#predictDonateBtn').on('click', function() {
        const file = $('#donateFingerprint')[0].files[0];
        if (!file) {
            alert('Please select a fingerprint image');
            return;
        }

        const formData = new FormData();
        formData.append('fingerprint', file);
        
        $(this).html('<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...');
        
        $.ajax({
            url: '/api/model/predict',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                predictedGroup = response.predicted_group;
                confidence = response.confidence;
                
                let resultHtml = `
                    <div class="alert ${response.allowed_to_donate ? 'alert-success' : 'alert-warning'}">
                        <h6 class="alert-heading">
                            <i class="fas fa-${response.allowed_to_donate ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                            Analysis Result
                        </h6>
                        <p><strong>Predicted Blood Group:</strong> ${predictedGroup}</p>
                        <p><strong>Confidence:</strong> ${(confidence * 100).toFixed(1)}%</p>
                        ${response.allowed_to_donate ? 
                            (predictedGroup === requiredGroup ? 
                                '<p class="mb-0 text-success"><i class="fas fa-heart me-2"></i><strong>Perfect Match! You can help this patient.</strong></p>' :
                                '<p class="mb-0 text-warning"><i class="fas fa-info-circle me-2"></i><strong>Blood group mismatch, but you can still register for future compatibility.</strong></p>'
                            ) : 
                            '<p class="mb-0">Confidence level too low for donation. Please try a clearer image.</p>'
                        }
                    </div>
                `;
                
                $('#donateResult').html(resultHtml);
                
                if (response.allowed_to_donate) {
                    $('#donorForm').removeClass('d-none');
                    $('#donorName').focus();
                }
                
                $('#predictDonateBtn').html('<i class="fas fa-brain me-2"></i>Verify Blood Group');
            },
            error: function() {
                $('#donateResult').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error analyzing fingerprint. Please try again.
                    </div>
                `);
                $('#predictDonateBtn').html('<i class="fas fa-brain me-2"></i>Verify Blood Group');
            }
        });
    });

    // Donor form submission
    $('#donorForm').on('submit', function(e) {
        e.preventDefault();
        
        const donorData = {
            donor_name: $('#donorName').val(),
            donor_contact: $('#donorContact').val(),
            donor_blood_group: predictedGroup,
            confidence: confidence
        };
        
        $.ajax({
            url: `/api/requests/${requestId}/optin`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(donorData),
            success: function(response) {
                showSuccessMessage('Thank you! Your registration has been submitted. The requester will contact you soon.');
                $('#donorForm')[0].reset();
                $('#donorForm').addClass('d-none');
            }})});